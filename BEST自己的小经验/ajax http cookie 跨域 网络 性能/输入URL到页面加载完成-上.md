## 1.输入URL地址

从记录（书签、历史记录）中智能匹配URL.

## 2.查找域名的IP地址

查找顺序：浏览器缓存->操作系统缓存->路由器缓存->ISP DNS缓存（LDNS查询/本地DNS查询）->递归搜索

### 2.1 浏览器缓存

    浏览器检查缓存是否有这个域名对应得到解析过的IP地址。如果有，这个解析过程就结束了。
    
    浏览器缓存域名不仅大小有限制，缓存的时间也有限制。
    
        如果缓存时间太长，一旦域名被解析到的IP地址有变化，会导致被客户端缓存的域名无法解析到变化后的IP地址以致该域名不能正常解析，这段时间用户就无法正常访问页面了。
        
        如果时间设置太短，会导致用户每次访问网站都要重新解析一次域名。

### 2.2 操作系统缓存

    如果浏览器缓存没有，浏览器就会查找操作系统缓存。操作系统也会有一个域名解析的过程，在Windows中可以通过C:\Windows\System32\drivers\etc\hosts文件来设置。
    如果你在这里指定了一个域名对应的IP地址，那么浏览器会首先使用这个IP地址。
    
    但是正是因为有这种本地DNS解析的规程，所以黑客就有可能通过修改你的域名解析来把特定的域名解析到它指定的IP地址上，导致这些域名被劫持。
    如果有病毒把一些常用的域名，修改 hosts  文件，指向一些恶意的 ip，那么浏览器也会不加判断的去连接，是的，这正是很多病毒的惯用手法。

### 2.3 路由器缓存

    接下来，如果还是没有找到需要的缓存，将前面的查询请求发给路由器，它一般会有自己的DNS缓存。

### 2.4 ISP DNS缓存（LDNS查询/本地DNS查询）

    接下来，如果还是没有找到需要的缓存，操作系统会把这个域名发送给这里设置的LDNS，也就是本地区的域名服务器。
    
    这个DNS通常都提供给你本地互联网接入的一个DNS解析服务，例如你是在学校接入互联网，那么你的DNS服务器肯定在你的学校，如果你是在一个小区接入互联网的，
    那这个DNS就是提供给你接入互联网的应用提供商，即电信或者联通，也就是通常所说的SPA，那么这个DNS通常也会在你所在城市的某个角落，通常不会很远。
    在Windows下可以通过ipconfig查询这个地址。

### 2.5 递归搜索

> ==递归查询==：主机向本地域名服务器的查询一般都是采用==递归查询==。如果主机所询问的本地域名服务器不知道被查询的域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其根域名服务器继续发出查询请求报文(即替主机继续查询)，而不是让主机自己进行下一步查询。因此，递归查询返回的查询结果或者是所要查询的IP地址，或者是返回一个失败的响应，表示无法查询到所需的IP地址。

> ==迭代查询==：本地域名服务器向根域名服务器的查询通常是采用==迭代查询==。当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么返回给本地域名服务器所要查询的IP地址，要么返回给本地域名服务器下一步应当查询的域名服务器的IP地址。

![image](https://gss0.baidu.com/-fo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/f3d3572c11dfa9ec1c57ee6064d0f703918fc148.jpg)

    根据上面的图解步骤：
    
    3.主机先向其'本地域名服务器(local DNS server)'进行递归查询，如果缓存中没有，继续下一步。

    4.'本地域名服务器(local DNS server)'采用迭代查询，先向一个'根域名服务器(root name server)'发起解析请求。
    
    5.'根域名服务器(root name server)'告诉'本地域名服务器(local DNS server)'下一次查询的'顶级域名服务器(gTLD Server)'地址。
    
    6.'本地域名服务器(local DNS server)'向'顶级域名服务器(gTLD Server)'发起请求。
    
    7.'顶级域名服务器(gTLD Server)'返回Name Server服务器地址。
    
    8.'本地域名服务器(local DNS server)'向权限域名服务器发送请求进行查询。
    
    9.权限域名服务器告诉'本地域名服务器(local DNS server)'所查询的主机的IP地址。
    
    10.'本地域名服务器(local DNS server)'最后把查询结果告诉主机。

## 3.建立TCP链接：TCP三次握手

![image](http://img.blog.csdn.net/20160309093354101?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

    确认好了IP地址和端口号之后：
    第一次握手：建立连接。客户端发送连接请求报文段，等待服务器的确认；
    第二次握手：服务器收到客户请求的报文段。服务器对这个报文段进行确认，同时发送给客户端一个返回信息。
    第三次握手：客户端收到服务器的返回信息报文段，向服务器再发一个确认信息报文段。

## 4.浏览器向web服务器发送一个http请求

得到IP地址后，浏览器会开始构造一个`http请求`，一个`http请求报文`由请求行<request-line>、请求头部<headers>、空行＜blank-line＞和请求数据＜request-body＞4个部分组成。

![image](http://img.blog.csdn.net/20160523223129990?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

1. 请求行：由请求方法、URL和HTTP协议版本3个字段组成。

请求方法：

    GET向特定的资源发出请求。注意：GET方法不应当被用于产生“副作用”的操作中，例如在web app.中。其中一个原因是GET可能会被网络蜘蛛等随意访问。
    
    POST向指定资源提交数据进行处理请求(例如提交表单或者上传文件)。数据被包含在请求体中。POST请求可能会导致新的资源的建立和/或已有资源的修改。
    
    OPTIONS返回服务器针对特定资源所支持的HTTP请求方法。也可以利用向Web服务器发送'*'的请求来测试服务器的功能性。
    
    HEAD向服务器索要与GET请求相一致的响应，只不过响应体将不会被返回。这一方法可以在不必传输整个响应内容的情况下，就可以获取包含在响应消息头中的元信息。
    
    PUT向指定资源位置上传其最新内容。
    
    DELETE请求服务器删除Request-URI所标识的资源。
    
    TRACE回显服务器收到的请求，主要用于测试或诊断。
    
    CONNECTHTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器。

2. 请求头部：由关键字/值对组成，每行一对，关键字和值用英文冒号”:“分隔。请求头部通知服务器有关于客户端请求的信息，典型的请求头有：

[http请求头代码详解](http://tools.jb51.net/table/http_header)

3. 空行：最后一个请求头部之后是一个空行，发送回车符和换行符，通知服务器以下不再有请求头部。

4. 请求数据（请求正文）：HTTP要传输的内容。


    GET方法是默认的HTTP请求方法，我们日常用GET方法来提交表单数据，然而用GET方法提交的表单数据只经过了简单的编码，同时它将作为URL的一部分向Web服务器发送。
    因此，如果使用GET方法来提交表单数据就存在着安全隐患上。

    POST方法是GET方法的一个替代方法，它主要是向Web服务器提交表单数据，尤其是大批量的数据。POST方法克服了GET方法的一些缺点。
    通过POST方法提交表单数据时，数据不是作为URL请求的一部分而是作为标准数据传送给Web服务器，这就克服了GET方法中的信息无法保密和数据量太小的缺点。
    因此，出于安全的考虑以及对用户隐私的尊重，通常表单提交时采用POST方法。

## 5.服务器接收请求给出响应

客户端与服务器TCP三次握手后完成连接，客户端就向服务器发送了http请求。那么，这时候服务器会按照顺序做以下的事情：

    接收请求=>处理请求=>访问资源=>构建响应=>发送响应=>记录日志
    
### 5.1 接收请求报文

Web服务器从网络连接中读取请求报文并解析。

> Web服务器会不定期地从网络上接收输入数据。网络随时可能出现延迟。Web服务器从网络中读取数据并临时存储在内存中，直到收到足以解析的数据并理解其意义为止。

### 5.2 处理请求

服务器接收到请求后，根据方法、资源、首部和可选的主体部分来对请求进行处理。

### 5.3 对资源的映射及访问

Web服务器是资源服务器，它们负责发送预先创建好的内容。在Web服务器将内容传送给客户端之前，要将请求报文中的URI映射为Web服务器上适当的内容或内容生成器，以识别出内容的源头。

### 5.4 构建响应

一旦Web服务器识别出了资源，就执行请求方法中描述的动作，并返回响应报文。一个http响应报文由状态行<status-line>、响应头部<headers>、空行＜blank-line＞和响应数据＜response-body＞4个部分组成，响应报文的一般格式如下图：

![image](http://img.blog.csdn.net/20160523223247367?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

#### 5.4.1 状态码

- 100~199——信息性状态码

    
    100 Continue（继续）  说明收到了请求的初始部分，请客户端继续。

    101 Switching Protocols（切换协议）  说明服务器正在根据客户端的指定，将协议切换成Update首部所列的协议。

- 200~299——成功状态码

    
    200 OK（成功） 客户端请求成功，实体的主体部分包含了所请求的资源。
    
    201 Created（已创建）  请求成功并且服务器创建了新的资源。
    
    202 Accepted（已接受）  服务器已接受请求，但尚未处理。
    
    203 Non-Authoritative Information（非授权信息）  服务器已成功处理了请求，但返回的信息可能来自另一来源。

    204 No Content（无内容）  服务器成功处理了请求，但没有实体的主体部分。
    
    205 Reset Content（重置内容） 告知浏览器清除当前页面中的所有HTML表单元素。

    206 Partial Content（部分内容）  服务器成功处理了部分或Range（范围）请求。

- 300~399——重定向状态码


    300 Multiple Choices（多种选择） 针对请求，服务器根据请求者选择一项操作，或提供操作列表供请求者选择。
    
    301 Moved Permanently（永久移动） 请求的网页已永久移动到新位置。 服务器返回此响应（对 GET 或 HEAD 请求的响应）时，会自动将请求者转到新位置。
    
    302 Found（临时移动） 客户端使用Location首部给出的URL临时定位资源，将来的请求仍使用老的URL。
    
    303 See Other（查看其它位置） 告知客户端应用另一个URL获取资源。其主要目的是允许POST请求的响应将客户端定向到某个资源上去。
    
    304 Not Modified（未修改） 自从上次GET请求后，请求的最近资源未修改过。服务器返回此响应时，不会返回网页内容。
    
    305 Use Proxy（使用代理） 请求者只能使用代理访问请求的资源。（客户端是相对某个特定资源来解析这条相应的，不是针对所有请求。）
    
    307 Temporary Redirect（临时重定向）  客户端使用Location首部给出的URL临时定位资源。将来的请求应该使用老的URL。

- 400~499——客户端错误状态码


    400 Bad Request（错误请求） 告知客户端它发送了一个错误的请求
    
    401 Unauthorized（未授权） 请求要求身份验证。对于需要登录的网页，服务器可能返回此响应。
    
    403 Forbidden（禁止） 服务器拒绝请求。
    
    404 Not Found（未找到） 服务器无法找到所请求的URL。
    
    405 Method Not Allowed（方法禁用） 禁用请求中指定的方法。
    
    406 Not Acceptable（不接受） 服务器没有与客户端可接受的URL相匹配的资源。
    
    407 Proxy Authentication Required（需要代理授权） 请求身份验证，但用于要求对资源尽享认证的代理服务器。
    
    408 Request Timeout（请求超时） 请求超时，服务器关闭连接。
    
    409 Conflict（冲突） 服务器在完成请求时发生冲突。
    
    410 Gone（已删除） 服务器找不到所请求的资源，但曾有过这个资源。
    
    411 Length Required（需要有效长度） 服务器要求在请求报文中包含Content-Length首部。
    
    412 Precondition Failed（未满足前提条件） 服务器未满足客户端发起的前提条件。
    
    413 Request Entity Too Large（请求实体过大） 服务器无法处理请求，请求实体过大，超出服务器处理能力。
    
    414 Request URI Too Long（请求的URI过长） 服务器无法处理请求，请求实体过长，超出服务器处理能力。
    
    415 Unsupported Media Type（不支持的媒体类型） 服务器不支持客户端所发实体的内容类型。
    
    416 Requested Range Not Satisfiable（请求范围不符合要求） 此范围无效或无法满足。
    
    417 Expectation Failed（未满足期望值） 服务器无法满足Expect请求首部的期望。

- 500~599——服务器错误状态码


    500 Inter Sever Error（服务器内部错误） 服务器遇到错误，无法完成请求。
    
    501 Not Implemented（尚未实施） 客户端发起的请求超出服务器的能力范围。
    
    502 Bad Gateway（错误网关） 作为代理或网关使用的服务器收到了一条伪响应。
    
    503 Service Unavailable（服务不可用） 服务器目前无法使用（超载或者停机维护）。
    
    504 Gateway Timeout（网关超时）作为代理或网关使用的服务器，等待另一服务器对其请求进行响应时超时了。
    
    505 HTTP Version Not supported（HTTP版本不受支持）服务器不支持请求中所用的 HTTP 协议版本。

==200 - 服务器成功返回网页==

==404 - 请求的网页不存在==

==503 - 服务不可用==

#### 5.4.2 响应头

响应头部：由关键字/值对组成，每行一对，关键字和值用英文冒号”:“分隔，典型的响应头有：

[http响应头代码详解](http://tools.jb51.net/table/http_header)

#### 5.4.3 响应空行

空行：最后一个响应头部之后是一个空行，发送回车符和换行符，通知浏览器以下不再有响应头部。

#### 5.4.4 响应实体

如果事务处理产生了响应主体，就将内容放在响应报文中回送过去。响应报文中通常包括：

    描述了响应主体MIME类型的Content-Type首部;
    描述了响应主体长度的Content-Length首部;
    实际报文的主题内容。
    
#### 5.4.5 ▲▲重定向

Web服务器有时会返回重定向响应而不是成功的报文，将浏览器重定向到其他地方来执行请求。

▲`重定向`的目标是`尽快地`将HTTP报文发送到`可用的Web服务器`上去。

##### 5.4.5.1 重定向一般用于下列情况：

    永久搬离的资源：资源被移动或者重新命名，服务器告诉客户端资源已经被“搬离”。返回301.
    
    临时搬离的资源：资源被临时移动或者重新命名，服务器告诉客户端资源临时被“搬离”，将来可以使用老的URL。返回303/307.
    
    ▲▲▲ URL增强：服务器通常用重定向重写URL。当请求到达时，服务器生成新的包含了嵌入式状态信息的URL，并将用户重定向到这个新的URL上去。客户端也会跟随这个重定向信息，重新发起请求。返回303/307.
    
    负载均衡：一个超载的服务器收到请求，服务器将客户端重定向到负载不太重的服务器上去。返回303/307.
    
    服务器关联：Web服务器可能会有某些用户的本地信息，服务器可以将客户端重定向到包含了那个客户端信息的服务器上去。返回303/307.
    
    规范目录名称：大多数Web服务器将客户端重定向到一个加了斜线的URI上，这样相对链接就可以正常工作了。
    
##### 5.4.5.2 重定向的作用：

重定向即是把一个目录或者文件的访问请求转发至另外一个目录或者文件，当用户发出相应的访问请求时将自动跳转到指定的位置，常见的重定向有301（永久重定向）及302（暂时重定向）两种。

> `301永久性重定向`：在做`搜索引擎优`化时对URL进行重定向都会使用`301永久性重定向`，重定向常用于域名或者目录变更的情况，可以有效实现新旧域名或者新旧目录之间的无缝对接。不管是对于普通用户还是搜索引擎都是十分友好的。搜索引擎可以识别`301的永久性重定向`从而将原来URL上的权重转移到你重定向后的新URL上，这对`搜索引擎优化`是非常重要的。有些人也会利用重定向，向搜索引擎返回经过特别优化甚至是作弊的页面，搜索引擎已经把部分重定向方式列入违规行为的行列。
    
▲▲▲ 如果服务器返回了==重定向响应==，那么这时候就先不会执行本文后面的操作。而是会立即执行==浏览器跟踪重定向地址==，然后==和新地址的服务器建立连接==，连接建立后浏览器会==发送另一个http请求==给新地址的服务器。这时候新地址的服务器会接收这个http请求然后进行处理，也就是刚才我们所提及的服务器处理请求的操作以及后面我们将要提到的服务器发送响应。

### 5.5 发送响应

Web服务器发回一个HTML响应。服务器会记录连接的状态，还特别注意对持久连接的处理。

    对非持久连接（connection模式为close）：服务器在发送了整条报文之后，服务器主动关闭TCP 连接，客户端被动关闭连接，释放TCP连接。
    
    对持久连接（connection模式为keepalive）：连接仍保持打开状态，这时服务器要特别小心，要正确计算Content-Length首部，不然客户端就无法知道响应什么时候结束了。
    
[（TCP连接关闭——四次释放）](https://baike.baidu.com/item/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/7794287?fr=aladdin)

### 5.6 记录事务处理过程

    当事务结束时，Web服务器会在日志文件中添加一个条目来描述已执行的事务。（原因：跟踪使用情况、安全性、计费、错误检测等等）